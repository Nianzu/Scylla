#!/bin/bash
# pre-commit hook to run code, log the performance score, and stage updated files

# 1. Run the code.
# This assumes that running 'cargo run --release' will generate or update
# the file 'last_mnist_results' with the latest score.
cargo run --release

# 2. Verify that the score file exists.
if [ ! -f "last_mnist_results" ]; then
  echo "Error: last_mnist_results not found! Exiting pre-commit hook."
  exit 1
fi
score=$(cat last_mnist_results)

# 3. Get the current timestamp.
timestamp=$(date +'%Y-%m-%d %H:%M:%S')

# 4. Prepare or update the CSV log.
csv_file="performance.csv"
# If the CSV doesn't exist, create it with headers.
if [ ! -f "$csv_file" ]; then
  echo "commit,timestamp,score" > "$csv_file"
fi

# Retrieve the current HEAD commit hash (note: this is the previous commit)
commit_hash=$(git rev-parse HEAD)
echo "$commit_hash,$timestamp,$score" >> "$csv_file"
echo "Performance data updated in $csv_file"

# 5. Stage the updated CSV and score file for the current commit.
git add "$csv_file" last_mnist_results line_plot.png

exit 0
